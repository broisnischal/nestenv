"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),r=require("path"),t=require("@rollup/pluginutils"),i=require("@swc/core"),n=require("@fastify/deepmerge"),s=require("get-tsconfig"),l=require("rollup-preserve-directives");function o(e){return e&&e.__esModule?e:{default:e}}var a=o(e),u=o(r),c=o(n),d=o(l);const f=new Map,p=(e,r,t)=>{var i,n,l;let o=`${r}:${null!=t?t:"undefined"}`;if(f.has(o))return null!==(i=f.get(o))&&void 0!==i?i:{};if(t&&u.default.isAbsolute(t)){let e=null!==(n=s.parseTsconfig(t).compilerOptions)&&void 0!==n?n:{},r=u.default.dirname(t);return(null!=e.paths||null!=e.baseUrl)&&(e.baseUrl=null!=e.baseUrl?u.default.resolve(r,e.baseUrl):r),f.set(o,e),e}let a=s.getTsconfig(r,t||"tsconfig.json");a||t||(e.warn({message:"Can't find tsconfig.json, trying jsconfig.json now",pluginCode:"SWC_TSCONFIG_NOT_EXISTS"}),a=s.getTsconfig(r,"jsconfig.json"));let c=null!==(l=null==a?void 0:a.config.compilerOptions)&&void 0!==l?l:{};if((null!=c.paths||null!=c.baseUrl)&&(null==a?void 0:a.path)){let e=u.default.dirname(a.path);c.baseUrl=null!=c.baseUrl?u.default.resolve(e,c.baseUrl):e}return f.set(o,c),c},m=/\.[cm]?[jt]sx?$/,v=/node_modules/,x=[".ts",".tsx",".mjs",".js",".cjs",".jsx"],y=c.default({all:!0,mergeArray:e=>(r,t)=>e.clone(t)}),g=e=>a.default.promises.access(e,a.default.constants.F_OK).then(()=>!0).catch(()=>!1);function j(e={}){let n=t.createFilter(e.include||m,e.exclude||v),s=e.extensions||x,l=async(e,t=!1)=>{let i=e.replace(m,"");for(let n of s){let s=t?r.join(e,`index${n}`):`${i}${n}`;if(await g(s))return s}return null};return{name:"swc",async resolveId(e,t){if(e.startsWith("\0")||!n(t))return null;if(t&&"."===e[0]){let i=r.resolve(t?r.dirname(t):process.cwd(),e),n=await l(i);if(n||!n&&await g(i)&&(await a.default.promises.stat(i)).isDirectory()&&(n=await l(i,!0)))return n}},async transform(t,l){var o;if(!n(l))return null;let a=r.extname(l);if(!s.includes(a))return null;let u=".ts"===a||".mts"===a||".cts"===a||".tsx"===a,c=!1===e.tsconfig?{}:p(this,r.dirname(l),e.tsconfig),d="react-jsx"===c.jsx||"react-jsxdev"===c.jsx,f={jsc:{externalHelpers:c.importHelpers,parser:{syntax:u?"typescript":"ecmascript",[u?"tsx":"jsx"]:u?".tsx"===a:".jsx"===a,decorators:c.experimentalDecorators},transform:{decoratorMetadata:c.emitDecoratorMetadata,react:{runtime:d?"automatic":"classic",importSource:c.jsxImportSource,pragma:c.jsxFactory,pragmaFrag:c.jsxFragmentFactory,development:"react-jsxdev"===c.jsx||void 0}},target:null===(o=c.target)||void 0===o?void 0:o.toLowerCase(),baseUrl:c.baseUrl,paths:c.paths}},{filename:m,include:v,exclude:x,tsconfig:g,extensions:j,minify:b,...h}=e,w=y(f,h,{jsc:{minify:void 0},filename:l,minify:!1});return i.transform(t,w)},renderChunk(r){var t,n,s,l,o;return e.minify||(null===(n=e.jsc)||void 0===n?void 0:null===(t=n.minify)||void 0===t?void 0:t.mangle)||(null===(l=e.jsc)||void 0===l?void 0:null===(s=l.minify)||void 0===s?void 0:s.compress)?i.minify(r,{...null===(o=e.jsc)||void 0===o?void 0:o.minify,module:!0}):null}}}Object.defineProperty(exports,"preserveUseDirective",{enumerable:!0,get:function(){return d.default}}),exports.default=j,exports.defineRollupSwcMinifyOption=function(e){return e},exports.defineRollupSwcOption=function(e){return e},exports.minify=function(e={}){return{name:"swc-minify",renderChunk:{order:"post",handler:r=>i.minify(r,e)}}},exports.swc=j,exports.viteMinify=function(e={}){return{name:"vite-swc-minify",enforce:"post",apply:"build",config(e){var r;return(null===(r=e.build)||void 0===r?void 0:r.minify)&&(e.build.minify=!1,e.build.cssMinify||(e.build.cssMinify=!0)),e},renderChunk:{order:"post",handler:r=>i.minify(r,e)}}};
